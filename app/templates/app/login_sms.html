{% extends 'app/layout/basic.html' %}
{% load static %}

{% block title %}短信登录{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/css/account.css' %}">
    <style>
        /* 错误信息样式 */
        .error-msg {
            color: red;
            font-size: 12px;
            position: absolute; /* 相对于 form-group 定位 */
            bottom: -5px;      /* 调整位置，避免与输入框重叠 */
        }
        .form-group {
            position: relative; /* 为错误信息提供定位上下文 */
            padding-bottom: 10px; /* 为错误信息预留空间 */
        }
    </style>
{% endblock %}

{% block content %}
<div class="account">
    <h2 class="title">短信登录</h2>
    <form id="loginForm" method="post" novalidate>
        {% csrf_token %}

        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>

                {% if field.name == 'code' %}
                    {# 验证码字段特殊布局，输入框和按钮同行显示 #}
                    <div class="row">
                        <div class="col-xs-7">{{ field }}</div>
                        <div class="col-xs-5">
                            <button id="btnGetCode" type="button" class="btn btn-default btn-block">点击获取验证码</button>
                        </div>
                    </div>
                {% else %}
                    {# 普通字段直接渲染 #}
                    {{ field }}
                {% endif %}

                <span class="error-msg"></span>
            </div>
        {% endfor %}

        <button id="btnSubmit" type="button" class="btn btn-primary btn-block">登 录</button>
    </form>
</div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {

    // 绑定获取验证码按钮的点击事件
    $('#btnGetCode').click(function() {
        const $btn = $(this);
        const $mobileField = $('#id_mobile_phone');
        const $errorSpan = $mobileField.closest('.form-group').find('.error-msg');

        // 清除旧的错误信息
        $errorSpan.text('');

        // 发送AJAX请求获取验证码
        $.ajax({
            url: "{% url 'send_sms' %}",
            type: 'GET',
            data: {
                mobile_phone: $mobileField.val(),
                tpl: 'login'
            },
            dataType: 'json',
            success: function(res) {
                if (res.status) {
                    // 发送成功，开始倒计时
                    startCountdown($btn);
                } else {
                    // 显示后端返回的错误信息
                    $.each(res.error, function(key, messages) {
                        $(`#id_${key}`).closest('.form-group').find('.error-msg').text(messages[0]);
                    });
                }
            },
            error: function() {
                $errorSpan.text('网络错误，请稍后重试');
            }
        });
    });

    // 绑定登录按钮的点击事件
    $('#btnSubmit').click(function() {
        // 提交前清除所有错误信息
        $('.error-msg').text('');

        $.ajax({
            url: "{% url 'login_sms' %}",
            type: 'POST',
            data: $('#loginForm').serialize(), // 序列化表单数据
            dataType: 'json',
            success: function(res) {
                if (res.status) {
                    // 登录成功，跳转到指定页面
                    location.href = res.data;
                } else {
                    // 登录失败，显示错误信息
                    $.each(res.error, function(key, messages) {
                        $(`#id_${key}`).closest('.form-group').find('.error-msg').text(messages[0]);
                    });
                }
            },
            error: function() {
                 // 通常在登录按钮下显示通用错误
                 $('#btnSubmit').closest('.form-group').find('.error-msg').text('登录失败，请检查网络');
            }
        });
    });

    /**
     * 启动按钮倒计时
     * @param {jQuery} $btn - 需要进行倒计时的按钮对象
     */
    function startCountdown($btn) {
        let seconds = 60;
        $btn.prop('disabled', true).text(`${seconds}秒后重试`);

        const timer = setInterval(function() {
            seconds--;
            if (seconds > 0) {
                $btn.text(`${seconds}秒后重试`);
            } else {
                clearInterval(timer);
                $btn.prop('disabled', false).text('点击获取验证码');
            }
        }, 1000);
    }
});
</script>
{% endblock %}
