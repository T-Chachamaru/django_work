{% extends 'app/layout/manage.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/plugin/editor-md/css/editormd.preview.min.css' %}">
    <style>
        .panel-default { margin-top: 10px; }
        .panel-default .panel-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-body { padding: 0; }
        .title-list {
            border-right: 1px solid #dddddd;
            min-height: 600px;
            padding: 15px 0;
        }
        .content {
            border-left: 1px solid #dddddd;
            min-height: 600px;
            margin-left: -1px;
            padding: 20px;
        }
        #catalog, #catalog ul { list-style: none; padding-left: 25px; }
        #catalog { padding-left: 15px; }
        #catalog li { position: relative; padding: 2px 0; }
        #catalog li::before, #catalog li::after { content: ''; position: absolute; left: -15px; background-color: #ccc; }
        #catalog li::before { top: 15px; width: 10px; height: 1px; }
        #catalog li:not(:last-child)::after { top: 0; width: 1px; height: 100%; }
        #catalog a { display: block; padding: 6px 10px; color: #333; text-decoration: none; transition: all 0.2s ease; border-radius: 4px; }
        #catalog a:hover { background-color: #f5f5f5; }
        #catalog a.active { background-color: #337ab7; color: #fff; font-weight: bold; }
        #catalog a i { margin-right: 8px; color: #999; }
        #catalog a.active i { color: #fff; }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div><i class="fas fa-book"></i> Wiki文档</div>
                <div class="function" id="wiki-actions">
                    <a type="button" class="btn btn-success btn-xs" href="{% url 'wiki_add' project_id=request.tracer.project.id %}">
                        <i class="fas fa-plus-circle"></i> 新建
                    </a>
                </div>
            </div>
            <div class="panel-body">
                <div class="col-sm-3 title-list">
                    <ul id="catalog">
                        <li><i class="fas fa-spinner fa-spin"></i> 正在加载目录...</li>
                    </ul>
                </div>
                <div class="col-sm-9 content" id="wiki-content-area">
                    <div class="wiki-placeholder" style="text-align: center; margin-top: 50px;">
                        <h4>《{{ request.tracer.project.name }}》Wiki文档库</h4>
                        <p>请从左侧目录选择一篇文章进行查看，或 <a href="{% url 'wiki_add' project_id=request.tracer.project.id %}">
                            <i class="fas fa-plus-circle"></i> 新建文章
                        </a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'app/plugin/editor-md/editormd.min.js' %}"></script>
    <script src="{% static 'app/plugin/editor-md/lib/marked.min.js' %}"></script>
    <script src="{% static 'app/plugin/editor-md/lib/prettify.min.js' %}"></script>
    <script>
        /**
         * Wiki 单页面应用 (SPA) 管理器
         * - 封装所有Wiki浏览页面的交互逻辑。
         * - 通过AJAX实现无刷新加载文章。
         * - 使用History API管理浏览器历史记录。
         */
        const WikiSPA = {
            endpoints: {
                catalog: "{% url 'wiki_catalog' project_id=request.tracer.project.id %}",
                wikiBase: "{% url 'wiki' project_id=request.tracer.project.id %}",
                add: "{% url 'wiki_add' project_id=request.tracer.project.id %}",
                editTemplate: "{% url 'wiki_edit' project_id=request.tracer.project.id wiki_id=99999 %}",
                deleteTemplate: "{% url 'wiki_delete' project_id=request.tracer.project.id wiki_id=99999 %}",
            },
            elements: {
                catalogContainer: $('#catalog'),
                contentArea: $('#wiki-content-area'),
                actionsContainer: $('#wiki-actions'),
            },
            initialContent: null,

            /**
             * 初始化函数，页面加载后执行
             */
            init: function () {
                this.initialContent = this.elements.contentArea.html();
                this.initCatalog();
                this.bindEvents();

                const initialWikiId = new URLSearchParams(window.location.search).get('wiki_id');
                if (initialWikiId) {
                    this.loadWikiContent(initialWikiId, false);
                }
            },

            /**
             * 绑定所有事件监听器
             */
            bindEvents: function () {
                const self = this;
                self.elements.catalogContainer.on('click', 'a', function (e) {
                    e.preventDefault();
                    const wikiId = $(this).data('wiki-id');
                    if (wikiId) {
                        self.loadWikiContent(wikiId);
                    }
                });

                window.onpopstate = function (event) {
                    const wikiId = event.state ? event.state.wikiId : null;
                    if (wikiId) {
                        self.loadWikiContent(wikiId, false);
                    } else {
                        self.restoreInitialState();
                    }
                };
            },

            /**
             * 初始化Markdown预览引擎
             */
            initPreviewMarkdown: function () {
                const previewContainer = this.elements.contentArea.find("#previewMarkdown");
                if (previewContainer.length) {
                    editormd.markdownToHTML(previewContainer.attr('id'), {
                        htmlDecode: "style,script,iframe",
                    });
                }
            },

            /**
             * AJAX加载并渲染Wiki目录
             */
            initCatalog: function () {
                const self = this;
                $.ajax({
                    url: self.endpoints.catalog,
                    type: "GET",
                    dataType: "json",
                    success: function (response) {
                        if (response.status) {
                            self.renderCatalog(response.data);
                        } else {
                            self.elements.catalogContainer.html('<li><i class="fas fa-exclamation-circle"></i> 目录加载失败</li>');
                        }
                    },
                    error: function () {
                        self.elements.catalogContainer.html('<li><i class="fas fa-exclamation-circle"></i> 网络错误</li>');
                    }
                });
            },

            /**
             * 渲染目录树 (与编辑页逻辑相同)
             * @param {Array} catalogData - 目录数据
             */
            renderCatalog: function (catalogData) {
                const self = this;
                self.elements.catalogContainer.empty();
                const catalogMap = {};
                $.each(catalogData, function (index, item) {
                    const $link = $('<a>', { href: 'javascript:void(0);', 'data-wiki-id': item.id, text: item.title })
                        .prepend($('<i>', { class: 'fas fa-file-alt' }));
                    const $li = $('<li>', { id: `wiki-node-${item.id}` }).append($link).append('<ul>');
                    catalogMap[item.id] = $li;
                });
                $.each(catalogData, function (index, item) {
                    const $li = catalogMap[item.id];
                    if (item.parent_id && catalogMap[item.parent_id]) {
                        catalogMap[item.parent_id].children('ul').append($li);
                    } else {
                        self.elements.catalogContainer.append($li);
                    }
                });
                $.each(catalogMap, function (id, $li) {
                    if ($li.children('ul').children('li').length > 0) {
                        $li.children('a').find('i').removeClass('fa-file-alt').addClass('fa-folder');
                    }
                });
            },

            /**
             * AJAX加载指定的Wiki文章内容并显示
             * @param {string} wikiId - 要加载的文章ID
             * @param {boolean} updateHistory - 是否创建新的浏览器历史记录
             */
            loadWikiContent: function (wikiId, updateHistory = true) {
                const self = this;
                self.elements.contentArea.html('<div style="text-align:center; margin-top:50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');

                $.ajax({
                    url: self.endpoints.wikiBase,
                    type: 'GET',
                    data: { wiki_id: wikiId },
                    dataType: 'json',
                    success: function (response) {
                        if (response.status) {
                            const wiki = response.data;
                            const contentHtml = `<div id="previewMarkdown"><textarea style="display:none;">${wiki.content}</textarea></div>`;
                            self.elements.contentArea.html(contentHtml);
                            self.initPreviewMarkdown();
                            self.updateActionButtons(wiki.id);
                            self.setActiveCatalog(wiki.id);

                            if (updateHistory) {
                                const detailUrl = `${self.endpoints.wikiBase}?wiki_id=${wikiId}`;
                                history.pushState({ wikiId: wikiId }, wiki.title, detailUrl);
                            }
                        } else {
                            self.elements.contentArea.html(`<p class="text-danger text-center" style="margin-top: 20px;">加载失败: ${response.error}</p>`);
                        }
                    },
                    error: function () {
                        self.elements.contentArea.html('<p class="text-danger text-center" style="margin-top: 20px;">网络错误，加载文章失败。</p>');
                    }
                });
            },

            /**
             * 设置目录中的高亮项
             * @param {string} wikiId - 要高亮的文章ID
             */
            setActiveCatalog: function (wikiId) {
                this.elements.catalogContainer.find('a').removeClass('active');
                this.elements.catalogContainer.find(`a[data-wiki-id='${wikiId}']`).addClass('active');
            },

            /**
             * 动态更新顶部的功能按钮（新建/编辑/删除）
             * @param {string} wikiId - 当前文章的ID
             */
            updateActionButtons: function (wikiId) {
                const editUrl = this.endpoints.editTemplate.replace('99999', wikiId);
                const deleteUrl = this.endpoints.deleteTemplate.replace('99999', wikiId);
                const buttonsHtml = `
                    <a type="button" class="btn btn-success btn-xs" href="${this.endpoints.add}"><i class="fas fa-plus-circle"></i> 新建</a>
                    <a type="button" class="btn btn-primary btn-xs" href="${editUrl}"><i class="fas fa-edit"></i> 编辑</a>
                    <a type="button" class="btn btn-danger btn-xs" href="${deleteUrl}"><i class="fas fa-trash"></i> 删除</a>
                `;
                this.elements.actionsContainer.html(buttonsHtml);
            },

            /**
             * 恢复页面到初始状态（显示欢迎信息和只有“新建”的按钮）
             */
            restoreInitialState: function () {
                this.elements.contentArea.html(this.initialContent);
                const buttonsHtml = `<a type="button" class="btn btn-success btn-xs" href="${this.endpoints.add}"><i class="fas fa-plus-circle"></i> 新建</a>`;
                this.elements.actionsContainer.html(buttonsHtml);
                this.setActiveCatalog(null);
            }
        };

        $(document).ready(function () {
            WikiSPA.init();
        });
    </script>
{% endblock %}