{% extends 'app/layout/basic.html' %}
{% load static %}

{% block title %}用户注册{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/css/account.css' %}">
    <style>
    </style>
{% endblock %}

{% block content %}
<div class="account">
    <h2 class="title">用户注册</h2>
    <form id="registerForm" method="post" novalidate>
        {% csrf_token %}
        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {% if field.name == 'code' %}
                    <div class="row">
                        <div class="col-xs-7">{{ field }}</div>
                        <div class="col-xs-5">
                            <button id="btnGetCode" type="button" class="btn btn-default btn-block">点击获取验证码</button>
                        </div>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
                <span class="error-msg"></span>
            </div>
        {% endfor %}
        <button id="btnSubmit" type="button" class="btn btn-primary btn-block">
            注 册
        </button>
    </form>
    <div class="text-center" style="margin-top: 15px;">
        <p class="small">已有账户？ <a href="{% url 'login' %}">立即登录</a></p>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    /**
     * AJAX 注册管理器
     * - 封装了获取验证码和提交注册表单的所有交互逻辑。
     * - 提供了更好的用户反馈和错误处理。
     */
    const RegisterManager = {
        endpoints: {
            sendSms: "{% url 'send_sms' %}",
            register: "{% url 'register' %}",
        },
        elements: {
            form: $('#registerForm'),
            btnGetCode: $('#btnGetCode'),
            btnSubmit: $('#btnSubmit'),
        },
        countdownTimer: null,

        init: function() {
            this.bindEvents();
        },

        /**
         * 绑定所有事件监听器
         */
        bindEvents: function() {
            const self = this;
            self.elements.btnGetCode.on('click', function() {
                self.handleSendSms();
            });
            self.elements.btnSubmit.on('click', function() {
                self.handleSubmit();
            });
        },

        /**
         * 处理发送短信验证码的逻辑
         */
        handleSendSms: function() {
            const self = this;
            const mobileField = $('#id_mobile_phone');
            const mobile = mobileField.val();
            if (!mobile) {
                self.showFieldError(mobileField, '请输入手机号');
                return;
            }
            self.clearAllErrors();
            self.elements.btnGetCode.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 发送中...');
            $.ajax({
                url: self.endpoints.sendSms,
                type: 'GET',
                data: { mobile_phone: mobile, tpl: 'register' },
                dataType: 'json',
                success: function(response) {
                    if (response.status) {
                        self.startCountdown();
                    } else {
                        self.displayErrors(response.error);
                        self.elements.btnGetCode.prop('disabled', false).text('点击获取验证码');
                    }
                },
                error: function() {
                    self.showFieldError(mobileField, '网络错误，请稍后重试');
                    self.elements.btnGetCode.prop('disabled', false).text('点击获取验证码');
                }
            });
        },

        /**
         * 处理提交注册表单的逻辑
         */
        handleSubmit: function() {
            const self = this;
            self.clearAllErrors();
            const originalButtonText = self.elements.btnSubmit.text();
            self.elements.btnSubmit.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 注册中...');

            $.ajax({
                url: self.endpoints.register,
                type: 'POST',
                data: self.elements.form.serialize(),
                dataType: 'json',
                success: function(response) {
                    if (response.status) {
                        window.location.href = response.data;
                    } else {
                        self.displayErrors(response.error);
                    }
                },
                error: function() {
                    self.displayErrors({ '__all__': ['注册失败，请检查网络后重试'] });
                },
                complete: function() {
                    self.elements.btnSubmit.prop('disabled', false).text(originalButtonText);
                }
            });
        },

        /**
         * 启动按钮倒计时
         */
        startCountdown: function() {
            const self = this;
            let seconds = 60;
            self.elements.btnGetCode.prop('disabled', true).text(`${seconds}秒后重试`);

            if (self.countdownTimer) {
                clearInterval(self.countdownTimer);
            }

            self.countdownTimer = setInterval(function() {
                seconds--;
                if (seconds > 0) {
                    self.elements.btnGetCode.text(`${seconds}秒后重试`);
                } else {
                    clearInterval(self.countdownTimer);
                    self.elements.btnGetCode.prop('disabled', false).text('点击获取验证码');
                }
            }, 1000);
        },

        /**
         * 显示后端返回的表单错误信息
         * @param {Object} errors - 错误对象，键为字段名，值为错误消息数组
         */
        displayErrors: function(errors) {
            const self = this;
            $.each(errors, function(key, messages) {
                if (key === '__all__') {
                    alert(messages[0]);
                } else {
                    const field = $(`#id_${key}`);
                    self.showFieldError(field, messages[0]);
                }
            });
        },

        /**
         * 在指定字段下方显示错误信息
         * @param {jQuery} $field - 字段的jQuery对象
         * @param {string} message - 错误消息
         */
        showFieldError: function($field, message) {
            $field.closest('.form-group').find('.error-msg').text(message);
        },

        /**
         * 清除所有字段的错误信息
         */
        clearAllErrors: function() {
            this.elements.form.find('.error-msg').text('');
        }
    };

    $(document).ready(function() {
        RegisterManager.init();
    });
</script>
{% endblock %}