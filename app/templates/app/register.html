{% extends 'app/layout/basic.html' %}
{% load static %}

{% block title %}用户注册{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/css/account.css' %}">
    <style>
        .error-msg {
            color: red;
            font-size: 12px;
            position: absolute;
            bottom: -5px;
        }
        .form-group {
            position: relative;
            padding-bottom: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="account">
    <h2 class="title">用户注册</h2>
    <form id="registerForm" method="post" novalidate>
        {% csrf_token %}

        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>

                {% if field.name == 'code' %}
                    <div class="row">
                        <div class="col-xs-7">{{ field }}</div>
                        <div class="col-xs-5">
                            <button id="btnGetCode" type="button" class="btn btn-default btn-block">点击获取验证码</button>
                        </div>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}

                <span class="error-msg"></span>
            </div>
        {% endfor %}

        <button id="btnSubmit" type="button" class="btn btn-primary btn-block">注 册</button>
    </form>
</div>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {

    $('#btnGetCode').click(function() {
        const $btn = $(this);
        const $mobileField = $('#id_mobile_phone');
        const $errorSpan = $mobileField.closest('.form-group').find('.error-msg');

        $errorSpan.text('');

        $.ajax({
            url: "{% url 'send_sms' %}",
            type: 'GET',
            data: {
                mobile_phone: $mobileField.val(),
                tpl: 'register'
            },
            dataType: 'json',
            success: function(res) {
                if (res.status) {
                    startCountdown($btn);
                } else {
                    $.each(res.error, function(key, messages) {
                        $(`#id_${key}`).closest('.form-group').find('.error-msg').text(messages[0]);
                    });
                }
            },
            error: function() {
                $errorSpan.text('网络错误，请稍后重试');
            }
        });
    });

    $('#btnSubmit').click(function() {
        $('.error-msg').text('');

        $.ajax({
            url: "{% url 'register' %}",
            type: 'POST',
            data: $('#registerForm').serialize(),
            dataType: 'json',
            success: function(res) {
                if (res.status) {
                    location.href = res.data;
                } else {
                    $.each(res.error, function(key, messages) {
                        $(`#id_${key}`).closest('.form-group').find('.error-msg').text(messages[0]);
                    });
                }
            },
            error: function() {
                alert('注册失败，请检查网络后重试');
            }
        });
    });

    /**
     * 启动按钮倒计时
     * @param {jQuery} $btn - 需要进行倒计时的按钮对象
     */
    function startCountdown($btn) {
        let seconds = 60;
        $btn.prop('disabled', true).text(`${seconds}秒后重试`);

        const timer = setInterval(function() {
            seconds--;
            if (seconds > 0) {
                $btn.text(`${seconds}秒后重试`);
            } else {
                clearInterval(timer);
                $btn.prop('disabled', false).text('点击获取验证码');
            }
        }, 1000);
    }
});
</script>
{% endblock %}
