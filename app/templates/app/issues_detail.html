{% extends 'app/layout/manage.html' %}
{% load static %}
{% load project %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/plugin/editor-md/css/editormd.min.css' %}">
    <link rel="stylesheet" href="{% static 'app/plugin/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css' %}">
    <link rel="stylesheet" href="{% static 'app/plugin/bootstrap-select-1.13.18/css/bootstrap-select.min.css' %}">
    <style>
        .edit-panel, .record-panel { padding: 20px; }
        .comment-area .item { margin-top: 20px; display: flex; }
        .comment-area .left-avatar {
            flex-shrink: 0; margin-right: 15px; width: 40px; height: 40px;
            background-color: #304659; color: white; text-align: center;
            line-height: 40px; border-radius: 50%; font-size: 18px; font-weight: bold;
        }
        .comment-area .right-info { flex-grow: 1; }
        .comment-area .right-info .info-header { font-weight: bold; margin-bottom: 5px; }
        .comment-area .right-info .info-content {
            background-color: #f5f5f5; padding: 10px; border-radius: 6px;
            word-wrap: break-word; white-space: pre-wrap;
        }
        .comment-area .right-info .info-footer {
            margin-top: 8px; font-size: 12px; color: #8c8c8c;
            display: flex; gap: 15px; align-items: center;
        }
        .comment-area .info-footer a.reply { color: #337ab7; cursor: pointer; }
        .comment-area .child { padding-left: 55px; margin-top: 15px; }
        #replyUser {
            display: inline-block; background-color: #e9ecef; color: black;
            padding: 6px 10px; margin-left: 10px; border-radius: 8px;
            cursor: pointer; font-size: 12px;
        }
        #replyUser i { margin-left: 8px; }
        /* 修复EditorMD全屏遮挡问题 */
        .editormd-fullscreen { z-index: 1051; }
        .form-horizontal .control-label { text-align: left; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 20px 0;">
    <div class="row">
        <!-- 左侧问题编辑区 -->
        <div class="col-sm-7">
            <div class="panel panel-default">
                <div class="panel-heading"><i class="fas fa-edit"></i> 更新问题</div>
                <div class="panel-body edit-panel">
                    <form id="editForm" class="form-horizontal" method="post" novalidate>
                        {% csrf_token %}
                        {% include 'app/inclusion/_form_field.html' with field=form.subject %}
                        <div class="form-group">
                            <label for="{{ form.desc.id_for_label }}" class="col-sm-2 control-label">{{ form.desc.label }}</label>
                            <div class="col-sm-10">
                                <div id="editor">{{ form.desc }}</div>
                                <span class="error-msg text-danger">{% if form.desc.errors %}{{ form.desc.errors.0 }}{% endif %}</span>
                            </div>
                        </div>
                        <div class="row">
                            {% include 'app/inclusion/_form_field_split.html' with field=form.status %}
                            {% include 'app/inclusion/_form_field_split.html' with field=form.priority %}
                        </div>
                        <div class="row">
                            {% include 'app/inclusion/_form_field_split.html' with field=form.issues_type %}
                            {% include 'app/inclusion/_form_field_split.html' with field=form.module %}
                        </div>
                        <div class="row">
                            {% include 'app/inclusion/_form_field_split.html' with field=form.assign %}
                            {% include 'app/inclusion/_form_field_split.html' with field=form.attention %}
                        </div>
                        <div class="row">
                            {% include 'app/inclusion/_form_field_split.html' with field=form.start_date %}
                            {% include 'app/inclusion/_form_field_split.html' with field=form.end_date %}
                        </div>
                         <div class="row">
                            {% include 'app/inclusion/_form_field_split.html' with field=form.mode %}
                            {% include 'app/inclusion/_form_field_split.html' with field=form.parent %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 右侧操作记录区 -->
        <div class="col-sm-5">
            <div class="panel panel-default">
                <div class="panel-heading"><i class="fas fa-history"></i> 操作记录</div>
                <div class="panel-body record-panel comment-area">
                    <div class="comment-list" id="commentList">
                        <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> 正在加载操作记录...</p>
                    </div>
                    <hr/>
                    <div class="comment-text" id="commentText">
                        <div class="form-group">
                            <textarea id="replyContent" rows="4" class="form-control" placeholder="请输入回复内容..."></textarea>
                            <span class="error-msg text-danger"></span>
                        </div>
                        <button class="btn btn-primary" type="button" id="btnSubmitReply">
                            <i class="fas fa-paper-plane"></i> 提 交
                        </button>
                        <div class="hide" id="replyUser" title="点击取消回复">
                            回复: <span></span> <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 用于克隆生成新记录的HTML模板 -->
<div class="hide" id="recordTemplate">
    <div class="item clearfix" data-id="" data-username="">
        <div class="left-avatar"></div>
        <div class="right-info">
            <div class="info-header">
                <span class="user"></span> <span class="text-muted small">创建了一条 <span class="type"></span></span>
            </div>
            <div class="info-content"></div>
            <div class="info-footer">
                <span class="date"></span>
                <a class="reply"><i class="fas fa-reply"></i> 回复</a>
            </div>
            <div class="child"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
    <script src="{% static 'app/plugin/editor-md/editormd.min.js' %}"></script>
    <script src="{% static 'app/plugin/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'app/plugin/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js' %}"></script>
    <script src="{% static 'app/plugin/bootstrap-select-1.13.18/js/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'app/plugin/bootstrap-select-1.13.18/js/i18n/defaults-zh_CN.min.js' %}"></script>

    <script>
        /**
         * 问题详情页交互管理器
         * 采用单例对象模式，将所有相关功能模块化。
         */
        const IssueDetailManager = {
            init: function() {
                // 全局设置AJAX，自动发送CSRF token
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                        }
                    }
                });

                this.PluginManager.init();
                this.RecordManager.init();
                this.FormChangeManager.init();
            },

            /**
             * 第三方插件初始化管理器
             */
            PluginManager: {
                editorInstance: null,
                init: function() {
                    this.initDatePicker();
                    this.initEditorMd();
                    // 初始化下拉选择框插件
                    $('.selectpicker').selectpicker();
                },
                initDatePicker: function() {
                    $('#id_start_date, #id_end_date').datetimepicker({
                        format: 'yyyy-mm-dd',
                        minView: "month",
                        language: 'zh-CN',
                        autoclose: true
                    });
                },
                initEditorMd: function() {
                    this.editorInstance = editormd('editor', {
                        placeholder: "请输入问题描述...",
                        height: 350,
                        path: "{% static 'app/plugin/editor-md/lib/' %}",
                        imageUpload: true,
                        imageFormats: ["jpg", "jpeg", "png", "gif"],
                        imageUploadURL: "{% url 'wiki_upload' project_id=request.tracer.project.id %}",
                        toolbarAutoFixed: false,
                        watch: true, // 开启实时预览
                        // 当编辑器内容改变时，触发自动保存
                        onchange: function() {
                            const content = this.getValue();
                            IssueDetailManager.FormChangeManager.postChange('desc', content);
                        },
                        toolbarIcons: () => ["undo", "redo", "|", "bold", "italic", "quote", "|", "h1", "h2", "h3", "|", "list-ul", "list-ol", "|", "link", "image", "code", "|", "watch", "preview", "fullscreen"],
                    });
                }
            },

            /**
             * 操作记录（评论/变更）管理器
             */
            RecordManager: {
                endpoint: "{% url 'issues_record' project_id=request.tracer.project.id issues_id=issues_object.id %}",
                elements: {
                    container: $('#commentList'),
                    contentInput: $('#replyContent'),
                    submitBtn: $('#btnSubmitReply'),
                    replyUserTag: $('#replyUser'),
                    template: $('#recordTemplate .item'),
                },

                init: function() {
                    this.loadRecords();
                    this.bindEvents();
                },

                bindEvents: function() {
                    const self = this;
                    // 绑定提交回复按钮
                    self.elements.submitBtn.on('click', () => self.handleSubmit());
                    // 绑定回复链接点击事件 (事件委托)
                    self.elements.container.on('click', '.reply', function() {
                        const $item = $(this).closest('.item');
                        const id = $item.data('id');
                        const username = $item.data('username');
                        self.setReplyTo(id, username);
                    });
                    // 绑定取消回复标签
                    self.elements.replyUserTag.on('click', () => self.cancelReply());
                },

                loadRecords: function() {
                    const self = this;
                    $.ajax({
                        url: self.endpoint,
                        type: "GET",
                        dataType: "json",
                        success: (res) => {
                            self.elements.container.empty();
                            if (res.status && res.data.length > 0) {
                                const recordMap = {};
                                $.each(res.data, (index, item) => {
                                    recordMap[item.id] = self.createRecordNode(item);
                                });
                                $.each(res.data, (index, item) => {
                                    const $node = recordMap[item.id];
                                    if (item.reply_id && recordMap[item.reply_id]) {
                                        recordMap[item.reply_id].find('.child').append($node);
                                    } else {
                                        self.elements.container.append($node);
                                    }
                                });
                            } else {
                                self.elements.container.html('<p class="text-muted">暂无操作记录。</p>');
                            }
                        },
                        error: () => self.elements.container.html('<p class="text-danger">记录加载失败。</p>')
                    });
                },

                createRecordNode: function(nodeDict) {
                    const $item = this.elements.template.clone();
                    $item.attr({'data-id': nodeDict.id, 'data-username': nodeDict.creator_name});
                    $item.find('.left-avatar').text(nodeDict.creator_name[0].toUpperCase());
                    $item.find('.user').text(nodeDict.creator_name);
                    $item.find('.type').text(nodeDict.reply_type === 1 ? '更新' : '回复');
                    $item.find('.info-content').text(nodeDict.content);
                    $item.find('.date').text(new Date(nodeDict.create_datetime).toLocaleString());

                    // 如果是变更记录，则隐藏回复按钮
                    if (nodeDict.reply_type === 1) {
                        $item.find('.reply').hide();
                    }
                    return $item;
                },

                appendRecordNode: function(nodeDict) {
                    const $newNode = this.createRecordNode(nodeDict);
                    this.elements.container.prepend($newNode);
                },

                handleSubmit: function() {
                    const self = this;
                    const content = self.elements.contentInput.val();
                    const parentId = self.elements.replyUserTag.attr('parent-id');

                    if (!content.trim()) {
                        self.elements.contentInput.next('.error-msg').text('回复内容不能为空');
                        return;
                    }

                    self.elements.contentInput.next('.error-msg').empty();
                    const originalBtnText = self.elements.submitBtn.html();
                    self.elements.submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                    $.ajax({
                        url: self.endpoint,
                        type: 'POST',
                        data: { content: content, reply: parentId },
                        dataType: 'json',
                        success: (res) => {
                            if (res.status) {
                                const $newNode = self.createRecordNode(res.data);
                                if (res.data.reply_id) {
                                    self.elements.container.find(`.item[data-id="${res.data.reply_id}"]`).find('.child').append($newNode);
                                } else {
                                    self.elements.container.append($newNode);
                                }
                                self.elements.contentInput.val('');
                                self.cancelReply();
                            } else {
                                self.elements.contentInput.next('.error-msg').text(res.error.content[0]);
                            }
                        },
                        error: () => alert('提交失败，请重试'),
                        complete: () => self.elements.submitBtn.prop('disabled', false).html(originalBtnText)
                    });
                },

                setReplyTo: function(id, username) {
                    this.elements.replyUserTag.removeClass('hide').attr('parent-id', id).find('span').text(username);
                    this.elements.contentInput.focus();
                },

                cancelReply: function() {
                    this.elements.replyUserTag.addClass('hide').removeAttr('parent-id').find('span').text('');
                }
            },

            /**
             * 表单字段变更自动提交管理器
             */
            FormChangeManager: {
                endpoint: "{% url 'issues_change' project_id=request.tracer.project.id issues_id=issues_object.id %}",

                init: function() {
                    const self = this;
                    $('#editForm').find('input, select, textarea').on('change', function() {
                        // 排除描述字段，因为它由EditorMD单独处理
                        if ($(this).attr('name') === 'desc') return;

                        const name = $(this).attr('name');
                        const value = $(this).val();
                        self.postChange(name, value);
                    });
                },

                postChange: function(name, value) {
                    const self = this;
                    const postData = { name: name, value: value };

                    // 清除旧的错误信息
                    $(`[name="${name}"]`).closest('.form-group').find('.error-msg').text('');

                    $.ajax({
                        url: self.endpoint,
                        type: "POST",
                        contentType: "application/json; charset=UTF-8", // 必须指定ContentType
                        data: JSON.stringify(postData),
                        dataType: "json",
                        success: (res) => {
                            if (res.status) {
                                // 成功后，将新的变更记录添加到操作历史中
                                IssueDetailManager.RecordManager.appendRecordNode(res.data);
                            } else {
                                // 失败则显示错误信息
                                $(`[name="${name}"]`).closest('.form-group').find('.error-msg').text(res.error);
                            }
                        },
                        error: () => {
                            $(`[name="${name}"]`).closest('.form-group').find('.error-msg').text('请求失败，请重试');
                        }
                    });
                }
            }
        };

        // 页面加载完成后，启动管理器
        $(document).ready(() => IssueDetailManager.init());
    </script>
{% endblock %}