{% extends 'app/layout/manage.html' %}
{% load static %}
{% load project %}

{% block css %}
<style>
    :root {
        --project-border-color: #e9ecef;
        --project-border-hover-color: #ffc107;
        --star-color: #adb5bd;
        --star-active-color: #ffc107;
    }
    .project-container { margin-top: 20px; }
    .panel-default > .panel-heading { background-color: #f8f9fa; font-weight: bold; }
    .panel-body { display: flex; flex-wrap: wrap; gap: 20px; min-height: 50px; }
    .project-item {
        width: calc(20% - 16px);
        min-height: 150px;
        border: 2px solid var(--project-border-color);
        border-radius: 8px;
        background-color: #fff;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }
    .project-item:hover {
        border-color: var(--project-border-hover-color);
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .project-item .title {
        color: #fff; font-size: 16px; font-weight: bold; padding: 20px;
        border-top-left-radius: 6px; border-top-right-radius: 6px;
        text-decoration: none; display: block;
    }
    .project-item .title:hover { text-decoration: none; color: #fff; }
    .project-item .info {
        padding: 15px; border-top: 1px solid #eee; display: flex;
        justify-content: space-between; align-items: center;
        color: #6c757d; font-size: 13px; flex-grow: 1;
    }
    .star-icon a { color: var(--star-color); text-decoration: none; font-size: 18px; transition: all 0.2s ease; }
    .star-icon a:hover { transform: scale(1.2); }
    .star-icon.starred a { color: var(--star-active-color); }
    .empty-message { width: 100%; text-align: center; color: #999; padding: 20px; }
    .color-radio label { margin-left: 0; padding-left: 0; }
    .color-radio input[type="radio"] { display: none; }
    .color-radio input[type="radio"] + .cycle { display: inline-block; height: 25px; width: 25px; border-radius: 50%; border: 2px solid #dddddd; }
    .color-radio input[type="radio"]:checked + .cycle { border: 2px solid black; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid project-container">
    <a class="btn btn-primary" data-toggle="modal" data-target="#addModal">
        <i class="fas fa-plus" aria-hidden="true"></i> 新建项目
    </a>

    <div class="panel panel-default" style="margin-top: 20px;">
        <div class="panel-heading"><i class="far fa-star"></i> 星标项目</div>
        <div class="panel-body" id="panel-body-star">
            {% for project_info in projects_dict.star %}
                {% render_project_card project_info.value project_info.type %}
            {% empty %}
                <p class="empty-message">您还没有星标任何项目。</p>
            {% endfor %}
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading"><i class="fas fa-list-ul"></i> 我创建的</div>
        <div class="panel-body" id="panel-body-my">
            {% for project in projects_dict.my %}
                {% render_project_card project 'my' %}
            {% empty %}
                <p class="empty-message">您还没有创建任何项目。</p>
            {% endfor %}
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading"><i class="far fa-handshake"></i> 我参与的</div>
        <div class="panel-body" id="panel-body-join">
            {% for project in projects_dict.join %}
                {% render_project_card project 'join' %}
            {% empty %}
                <p class="empty-message">您还没有参与任何项目。</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新建项目</h4>
            </div>
            <div class="modal-body">
                <form id="addForm" novalidate>
                    {% csrf_token %}
                    {% for field in form %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            <span class="error-msg"></span>
                        </div>
                    {% endfor %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取 消</button>
                <button id="btnSubmit" type="button" class="btn btn-primary">确 认</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    /**
     * 项目列表页面交互管理器
     */
    const ProjectListManager = {
        init: function() {
            this.ModalManager.init();
            this.StarManager.init();
        },

        /**
         * 新建项目 Modal 管理器
         */
        ModalManager: {
            elements: {
                form: $('#addForm'),
                submitBtn: $('#btnSubmit'),
                modal: $('#addModal'),
            },
            endpoint: "{% url 'project_list' %}",

            init: function() { this.bindEvents(); },

            bindEvents: function() {
                const self = this;
                self.elements.submitBtn.on('click', () => self.handleSubmit());
            },

            handleSubmit: function() {
                const self = this;
                self.clearErrors();
                const originalBtnText = self.elements.submitBtn.html();
                self.elements.submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 创建中...');

                $.ajax({
                    url: self.endpoint,
                    type: "POST",
                    data: self.elements.form.serialize(),
                    dataType: "json",
                    success: function (response) {
                        if (response.status) {
                            location.reload();
                        } else {
                            self.displayErrors(response.error);
                            self.elements.submitBtn.prop('disabled', false).html(originalBtnText);
                        }
                    },
                    error: function() {
                        alert('网络错误，请稍后重试');
                        self.elements.submitBtn.prop('disabled', false).html(originalBtnText);
                    }
                });
            },

            clearErrors: function() { this.elements.form.find('.error-msg').empty(); },

            displayErrors: function(errors) {
                $.each(errors, function (key, messages) {
                    $(`#id_${key}`).closest('.form-group').find('.error-msg').text(messages[0]);
                });
            }
        },

        /**
         * 星标功能管理器
         */
        StarManager: {
            init: function() { this.bindEvents(); },

            bindEvents: function() {
                const self = this;
                $('.project-container').on('click', '.js-star-toggle', function(e) {
                    e.preventDefault();
                    self.toggleStar($(this));
                });
            },

            toggleStar: function($link) {
                const projectType = $link.data('type');
                const projectId = $link.data('id');
                const url = `/project/star/${projectType}/${projectId}/`;

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    dataType: 'json',
                    success: (response) => {
                        if (response.status) {
                            this.handleSuccess(response, $link);
                        } else {
                            alert(response.error || '操作失败');
                        }
                    },
                    error: () => alert('网络错误，请稍后重试。')
                });
            },

            handleSuccess: function(response, $link) {
                const isStarred = response.starred;
                const projectType = $link.data('type');
                const $projectItem = $link.closest('.project-item');
                const $currentPanel = $projectItem.parent();
                const $destinationPanel = isStarred ? $('#panel-body-star') :
                                          (projectType === 'my' ? $('#panel-body-my') : $('#panel-body-join'));
                const $icon = $projectItem.find('i.fa-star');
                const $starSpan = $projectItem.find('.star-icon');
                $starSpan.toggleClass('starred', isStarred);
                $icon.toggleClass('fas', isStarred).toggleClass('far', !isStarred);

                $projectItem.fadeOut(300, function() {
                    $(this).prependTo($destinationPanel).fadeIn(300);
                    if ($currentPanel.find('.project-item').length === 0) {
                        const emptyMessages = {
                            'panel-body-star': '您还没有星标任何项目。',
                            'panel-body-my': '您还没有创建任何项目。',
                            'panel-body-join': '您还没有参与任何项目。'
                        };
                        $currentPanel.html(`<p class="empty-message">${emptyMessages[$currentPanel.attr('id')]}</p>`);
                    }
                });
                $destinationPanel.find('.empty-message').remove();
            }
        }
    };

    $(document).ready(() => ProjectListManager.init());
</script>
{% endblock %}