{% extends 'app/layout/basic.html' %}
{% load static %}

{% block title %}用户登录{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'app/css/account.css' %}">
    <style>
        .form-group {
            position: relative;
            padding-bottom: 18px;
            margin-bottom: 0;
        }
        #imageCode {
            cursor: pointer;
            height: 34px;
            width: 100%;
            object-fit: fill;
            border-radius: 4px;
        }
        .login-links {
            text-align: right;
            margin-bottom: 15px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="account">
    <h2 class="title">用户登录</h2>
    <form id="loginForm" method="post" novalidate>
        {% csrf_token %}
        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {% if field.name == 'code' %}
                    <div class="row">
                        <div class="col-xs-7">
                            {{ field }}
                        </div>
                        <div class="col-xs-5">
                            <img src="{% url 'image_code' %}" alt="图片验证码" id="imageCode" title="点击刷新">
                        </div>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
                {% if field.errors %}
                    <span class="error-msg">{{ field.errors.0 }}</span>
                {% endif %}
            </div>
        {% endfor %}

        {% if form.non_field_errors %}
            <div class="form-group">
                <span class="error-msg" style="position: static;">{{ form.non_field_errors.0 }}</span>
            </div>
        {% endif %}

        <div class="login-links">
            <a href="{% url 'login_sms' %}">短信验证码登录</a>
        </div>

        <button id="btnSubmit" type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> 登 录
        </button>
    </form>
    <div class="text-center" style="margin-top: 15px;">
        <p class="small">还没有账户？ <a href="{% url 'register' %}">立即注册</a></p>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    /**
     * 登录页面管理器
     * - 即使交互简单，也使用对象封装来保持代码风格的一致性。
     * - 负责处理图片验证码的点击刷新功能。
     */
    const LoginManager = {
        elements: {
            imageCode: $('#imageCode'),
        },

        init: function() {
            this.bindEvents();
        },

        /**
         * 绑定事件监听器
         */
        bindEvents: function() {
            const self = this;
            self.elements.imageCode.on('click', function() {
                self.refreshImageCode();
            });
        },

        /**
         * 刷新图片验证码。
         * 通过在URL后附加一个时间戳，强制浏览器重新请求图片，而不是使用缓存。
         */
        refreshImageCode: function() {
            const currentSrc = this.elements.imageCode.attr('src').split('?')[0];
            const newSrc = `${currentSrc}?timestamp=${new Date().getTime()}`;
            this.elements.imageCode.attr('src', newSrc);
        }
    };

    $(document).ready(function() {
        LoginManager.init();
    });
</script>
{% endblock %}